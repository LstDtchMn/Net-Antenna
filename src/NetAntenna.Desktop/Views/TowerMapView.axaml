<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:NetAntenna.Desktop.ViewModels"
             xmlns:model="using:NetAntenna.Core.Services"
             xmlns:mapsui="clr-namespace:Mapsui.UI.Avalonia;assembly=Mapsui.UI.Avalonia"
             x:Class="NetAntenna.Desktop.Views.TowerMapView"
             x:DataType="vm:TowerMapViewModel">

    <Grid RowDefinitions="Auto,*">

        <!-- â”€â”€â”€ Control Panel â”€â”€â”€ -->
        <Border Grid.Row="0" Background="#1E1E2E" CornerRadius="8" Padding="16,12" Margin="0,0,0,8">
            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto">

                <!-- Row 0: title, stats, download -->
                <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal" Spacing="20" VerticalAlignment="Center" Margin="0,0,0,12">
                    <TextBlock Text="ðŸ“¡ FCC Tower Map" FontSize="20" FontWeight="SemiBold" Foreground="White" VerticalAlignment="Center"/>
                    <StackPanel Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                        <TextBlock Text="Towers:" Foreground="#6C7086" FontSize="13"/>
                        <TextBlock Text="{Binding TowerCount, StringFormat='{}{0:N0}'}" Foreground="#A6E3A1" FontWeight="Bold" FontSize="13"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                        <TextBlock Text="Updated:" Foreground="#6C7086" FontSize="13"/>
                        <TextBlock Text="{Binding LastUpdateText}" Foreground="#CDD6F4" FontSize="13"/>
                    </StackPanel>
                </StackPanel>

                <!-- Download button top-right -->
                <StackPanel Grid.Row="0" Grid.Column="1" VerticalAlignment="Center" Margin="0,0,0,12" Spacing="6">
                    <Button Content="â¬‡ Download FCC Data"
                            Command="{Binding DownloadFccDataCommand}"
                            IsEnabled="{Binding !IsUpdating}"
                            Padding="14,8" Background="#313244" Foreground="White" CornerRadius="6">
                        <Button.Styles>
                            <Style Selector="Button:disabled">
                                <Setter Property="Content" Value="â³ Downloading..."/>
                                <Setter Property="Foreground" Value="#6C7086"/>
                            </Style>
                        </Button.Styles>
                    </Button>

                    <!-- Progress/status row -->
                    <TextBlock Text="{Binding FccDownloadProgress}"
                               IsVisible="{Binding FccDownloadProgress, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                               Foreground="#A6ADC8" FontSize="11" HorizontalAlignment="Right"/>
                </StackPanel>

                <!-- Row 1: Controls (Search & Map Options) -->
                <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Spacing="12" Margin="0,0,0,12">
                    
                    <!-- Top Row: Address Search and Manual Coordinates -->
                    <Grid ColumnDefinitions="*,Auto">
                        <!-- ADDRESS SEARCH with autocomplete overlay -->
                        <Panel Grid.Column="0" Margin="0,0,12,0">
                            <!-- Search input row -->
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBox Grid.Column="0"
                                         x:Name="AddressBox"
                                         Text="{Binding SearchAddress}"
                                         Watermark="Start typing your addressâ€¦"
                                         Padding="12,8" FontSize="13"
                                         Background="#11111B" Foreground="White"
                                         CaretBrush="White"
                                         BorderBrush="#45475A" BorderThickness="1"
                                         CornerRadius="6,0,0,6"/>
                                <Button Grid.Column="1"
                                        Content="ðŸ” Find"
                                        Command="{Binding SearchAddressCommand}"
                                        IsEnabled="{Binding !IsSearchingAddress}"
                                        Padding="16,8" FontSize="13"
                                        Background="#00BCD4" Foreground="White" FontWeight="SemiBold"
                                        CornerRadius="0,6,6,0">
                                    <Button.Styles>
                                        <Style Selector="Button:disabled">
                                            <Setter Property="Content" Value="â³"/>
                                            <Setter Property="Background" Value="#313244"/>
                                        </Style>
                                    </Button.Styles>
                                </Button>
                            </Grid>

                            <!-- Autocomplete dropdown overlay -->
                            <Border IsVisible="{Binding ShowSuggestions}"
                                    Background="#2A2A3E"
                                    BorderBrush="#585B70" BorderThickness="1"
                                    CornerRadius="0,0,8,8"
                                    BoxShadow="0 8 24 -4 #99000000"
                                    Margin="0,40,0,0"
                                    ZIndex="100"
                                    MaxHeight="240">
                                <ListBox ItemsSource="{Binding Suggestions}"
                                         Background="Transparent"
                                         SelectionMode="Single"
                                         Padding="4">
                                    <ListBox.Styles>
                                        <Style Selector="ListBoxItem">
                                            <Setter Property="Padding" Value="12,8"/>
                                            <Setter Property="CornerRadius" Value="4"/>
                                            <Setter Property="Cursor" Value="Hand"/>
                                        </Style>
                                        <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
                                            <Setter Property="Background" Value="#313244"/>
                                        </Style>
                                    </ListBox.Styles>
                                    <ListBox.ItemTemplate>
                                        <DataTemplate x:DataType="model:GeocodingSuggestion">
                                            <Button Command="{Binding $parent[UserControl].((vm:TowerMapViewModel)DataContext).SelectSuggestionCommand}"
                                                    CommandParameter="{Binding}"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    HorizontalAlignment="Stretch"
                                                    HorizontalContentAlignment="Left"
                                                    Padding="0"
                                                    Cursor="Hand">
                                                <StackPanel Spacing="1">
                                                    <TextBlock Text="{Binding DisplayName}"
                                                               Foreground="#CDD6F4"
                                                               FontSize="12"
                                                               TextTrimming="CharacterEllipsis"
                                                               MaxWidth="500"/>
                                                </StackPanel>
                                            </Button>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </Border>

                            <!-- Loading indicator -->
                            <TextBlock IsVisible="{Binding IsLoadingSuggestions}"
                                       Text="ðŸ” Searching..."
                                       Foreground="#6C7086" FontSize="11"
                                       Margin="4,42,0,0"
                                       ZIndex="99"/>
                        </Panel>

                        <!-- Manual lat/lng + Save -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                            <TextBlock Text="Lat:" Foreground="#6C7086" FontSize="12" VerticalAlignment="Center"/>
                            <TextBox Text="{Binding UserLat}" Width="80" Padding="8,6" FontSize="12"
                                     Background="#11111B" Foreground="White" BorderBrush="#45475A" CornerRadius="4"/>
                            <TextBlock Text="Lng:" Foreground="#6C7086" FontSize="12" VerticalAlignment="Center"/>
                            <TextBox Text="{Binding UserLng}" Width="90" Padding="8,6" FontSize="12"
                                     Background="#11111B" Foreground="White" BorderBrush="#45475A" CornerRadius="4"/>
                            <Button Content="ðŸ’¾ Save"
                                    Command="{Binding SaveLocationCommand}"
                                    Padding="12,6" FontSize="12"
                                    Background="#313244" Foreground="White" CornerRadius="4"/>
                        </StackPanel>
                    </Grid>

                    <!-- Bottom Row: Map Controls -->
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <!-- Group: Zoom In / Center / Zoom Out around User Location -->
                        <Border Background="#313244" CornerRadius="6" ClipToBounds="True">
                            <StackPanel Orientation="Horizontal">
                                <Button Content="âž•"
                                        Command="{Binding ZoomInToMeCommand}"
                                        Padding="10,8" FontSize="11"
                                        Background="Transparent" Foreground="#89DCEB" CornerRadius="6,0,0,6"
                                        ToolTip.Tip="Zoom IN centered on your location"/>
                                        
                                <Button Content="ðŸŽ¯ To Me"
                                        Command="{Binding ZoomToLocationCommand}"
                                        Padding="10,8" FontSize="13"
                                        Background="#45475A" Foreground="#89DCEB" CornerRadius="0"
                                        ToolTip.Tip="Center map on your saved location"/>

                                <Button Content="âž–"
                                        Command="{Binding ZoomOutFromMeCommand}"
                                        Padding="10,8" FontSize="11"
                                        Background="Transparent" Foreground="#89DCEB" CornerRadius="0,6,6,0"
                                        ToolTip.Tip="Zoom OUT centered on your location"/>
                            </StackPanel>
                        </Border>

                        <!-- Radius Filter -->
                        <ComboBox ItemsSource="{Binding RadiusOptions}"
                                  SelectedItem="{Binding SelectedRadius}"
                                  Padding="12,8" FontSize="13" MinWidth="180"
                                  Background="#313244" Foreground="White" CornerRadius="6"
                                  ToolTip.Tip="Filter map to only show towers within this range"/>
                                
                        <Button Content="ðŸ—ºï¸ Reset View"
                                Command="{Binding ResetMapCommand}"
                                Padding="12,8" FontSize="13"
                                Background="#313244" Foreground="#CDD6F4" CornerRadius="6"
                                ToolTip.Tip="Zoom out to show the entire US map"/>
                                
                        <Button Content="ðŸ—‘ï¸ Clear Pins"
                                Command="{Binding ClearTowersCommand}"
                                Padding="12,8" FontSize="13"
                                Background="#45475A" Foreground="#F38BA8" CornerRadius="6"
                                ToolTip.Tip="Remove all tower pins from the map (data remains saved in database)"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>

        <!-- â”€â”€â”€ Map â”€â”€â”€ -->
        <Panel Grid.Row="1">
            <Border Background="#11111B" CornerRadius="8" ClipToBounds="True">
                <mapsui:MapControl x:Name="TowerMap"/>
            </Border>

            <!-- Layer switcher â€” overlaid bottom-left of map -->
            <Border HorizontalAlignment="Left" VerticalAlignment="Bottom"
                    Margin="12,0,0,12"
                    Background="#CC1E1E2E"
                    BorderBrush="#45475A" BorderThickness="1"
                    CornerRadius="20"
                    Padding="4,3"
                    ZIndex="10">
                <StackPanel Orientation="Horizontal" Spacing="2">

                    <!-- Street -->
                    <Button Content="ðŸ—º Street"
                            Command="{Binding SetMapLayerCommand}"
                            CommandParameter="{x:Static vm:MapLayer.Street}"
                            Padding="10,5" FontSize="12" CornerRadius="16"
                            Foreground="{Binding SelectedMapLayer,
                                Converter={x:Static vm:MapLayerConverters.StreetForeground}}"
                            Background="{Binding SelectedMapLayer,
                                Converter={x:Static vm:MapLayerConverters.StreetBackground}}"/>

                    <!-- Terrain -->
                    <Button Content="â›° Terrain"
                            Command="{Binding SetMapLayerCommand}"
                            CommandParameter="{x:Static vm:MapLayer.Terrain}"
                            Padding="10,5" FontSize="12" CornerRadius="16"
                            Foreground="{Binding SelectedMapLayer,
                                Converter={x:Static vm:MapLayerConverters.TerrainForeground}}"
                            Background="{Binding SelectedMapLayer,
                                Converter={x:Static vm:MapLayerConverters.TerrainBackground}}"/>

                    <!-- Satellite -->
                    <Button Content="ðŸ›° Satellite"
                            Command="{Binding SetMapLayerCommand}"
                            CommandParameter="{x:Static vm:MapLayer.Satellite}"
                            Padding="10,5" FontSize="12" CornerRadius="16"
                            Foreground="{Binding SelectedMapLayer,
                                Converter={x:Static vm:MapLayerConverters.SatelliteForeground}}"
                            Background="{Binding SelectedMapLayer,
                                Converter={x:Static vm:MapLayerConverters.SatelliteBackground}}"/>

                </StackPanel>
            </Border>
        </Panel>

    </Grid>
</UserControl>
