<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:NetAntenna.Desktop.ViewModels"
             x:Class="NetAntenna.Desktop.Views.AimingAssistantView"
             x:DataType="vm:AimingAssistantViewModel">

    <Grid ColumnDefinitions="*,350" RowDefinitions="Auto,*">
        
        <Border Grid.Row="0" Grid.ColumnSpan="2" Background="#1E1E2E" CornerRadius="8" Padding="16" Margin="0,0,0,12">
            <StackPanel Spacing="4">
                <TextBlock Text="Antenna Aiming Assistant" FontSize="20" FontWeight="SemiBold" Foreground="White" />
                <TextBlock Text="Select target towers on the right. The compass will compute the optimal median bearing." Foreground="#B0B0B0" TextWrapping="Wrap"/>
            </StackPanel>
        </Border>
        
        <!-- Compass Display -->
        <Border Grid.Row="1" Grid.Column="0" Background="#11111B" CornerRadius="8" Margin="0,0,12,0" Padding="32">
            <Grid>
                <!-- Compass Rose Background -->
                <Ellipse Width="300" Height="300" Stroke="#313244" StrokeThickness="4" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                <TextBlock Text="N" Foreground="#F38BA8" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,-30,0,0"/>
                <TextBlock Text="S" Foreground="#B0B0B0" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Bottom" Margin="0,0,0,-30"/>
                <TextBlock Text="E" Foreground="#B0B0B0" FontSize="24" FontWeight="Bold" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,-30,0"/>
                <TextBlock Text="W" Foreground="#B0B0B0" FontSize="24" FontWeight="Bold" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="-30,0,0,0"/>
                
                <!-- Rotating Arrow Line -->
                <Canvas Width="300" Height="300" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Line StartPoint="150,150" EndPoint="150,0" Stroke="#A6E3A1" StrokeThickness="8" StrokeLineCap="Round">
                        <Line.RenderTransform>
                            <!-- Binding the Angle to our computed bearing -->
                            <RotateTransform Angle="{Binding RecommendedBearingAngle}" CenterX="150" CenterY="150"/>
                        </Line.RenderTransform>
                    </Line>
                    <Ellipse Canvas.Left="140" Canvas.Top="140" Width="20" Height="20" Fill="#A6E3A1"/>
                </Canvas>
                
                <!-- Heading Text -->
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,80,0,0">
                    <TextBlock Text="{Binding RecommendedBearingText}" FontSize="36" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                    <TextBlock Text="Heading" FontSize="14" Foreground="#B0B0B0" HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Right Sidebar: Tower Selection List -->
        <Border Grid.Row="1" Grid.Column="1" Background="#1E1E2E" CornerRadius="8">
            <ListBox ItemsSource="{Binding TargetTowers}" Background="Transparent">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <CheckBox IsChecked="{Binding IsSelected}" 
                                  Command="{Binding $parent[UserControl].((vm:AimingAssistantViewModel)DataContext).CalculateOptimalBearingCommand}">
                            <StackPanel Margin="8,4">
                                <TextBlock Text="{Binding Tower.CallSign}" FontSize="16" FontWeight="SemiBold" Foreground="White"/>
                                <TextBlock FontSize="12" Foreground="#B0B0B0">
                                    <Run Text="Ch "/>
                                    <Run Text="{Binding Tower.TransmitChannel}"/>
                                    <Run Text=" | "/>
                                    <Run Text="{Binding DistanceKm, StringFormat='{}{0:N1} km'}"/>
                                    <Run Text=" | "/>
                                    <Run Text="{Binding BearingDegrees, StringFormat='{}{0:N0}Â°'}"/>
                                </TextBlock>
                            </StackPanel>
                        </CheckBox>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Border>
    </Grid>
</UserControl>
